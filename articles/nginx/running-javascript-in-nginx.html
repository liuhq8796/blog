<!DOCTYPE html>
<html lang="en-US" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>在 Nginx 中运行 JavaScript | LucasLiu's 博客网站</title>
    <meta name="description" content="LucasLiu's 博客网站">
    <link rel="preload stylesheet" href="/assets/style.33da8088.css" as="style">
    <script type="module" src="/assets/app.54eb14c0.js"></script>
    <link rel="preload" href="/assets/inter-roman-latin.2ed14f66.woff2" as="font" type="font/woff2" crossorigin="">
  <link rel="modulepreload" href="/assets/chunks/framework.97fbe135.js">
  <link rel="modulepreload" href="/assets/chunks/theme.8781cd77.js">
  <link rel="modulepreload" href="/assets/articles_nginx_running-javascript-in-nginx.md.2c2b9be3.lean.js">
  <script id="check-dark-light">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-949fe70a><!--[--><!--]--><!--[--><span tabindex="-1" data-v-93dfdeac></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-93dfdeac> Skip to content </a><!--]--><!----><header class="VPNav" data-v-949fe70a data-v-1647ea30><div class="VPNavBar has-sidebar" data-v-1647ea30 data-v-e7bb3ccb><div class="container" data-v-e7bb3ccb><div class="title" data-v-e7bb3ccb><div class="VPNavBarTitle has-sidebar" data-v-e7bb3ccb data-v-0b6f3ca0><a class="title" href="/" data-v-0b6f3ca0><!--[--><!--]--><!----><!--[-->学海拾贝<!--]--><!--[--><!--]--></a></div></div><div class="content" data-v-e7bb3ccb><div class="curtain" data-v-e7bb3ccb></div><div class="content-body" data-v-e7bb3ccb><!--[--><!--]--><div class="VPNavBarSearch search" style="--vp-meta-key:&#39;Meta&#39;;" data-v-e7bb3ccb><!----></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-e7bb3ccb data-v-f44db5fe><span id="main-nav-aria-label" class="visually-hidden" data-v-f44db5fe>Main Navigation</span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/" tabindex="0" data-v-f44db5fe data-v-3b08e98d data-v-fd01078a><!--[-->首页<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/articles/" tabindex="0" data-v-f44db5fe data-v-3b08e98d data-v-fd01078a><!--[-->全部文章<!--]--><!----></a><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-e7bb3ccb data-v-a36d7491><label title="toggle dark mode" data-v-a36d7491 data-v-82e841ac><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" aria-checked="false" data-v-82e841ac data-v-62d1e791><span class="check" data-v-62d1e791><span class="icon" data-v-62d1e791><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-82e841ac><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-82e841ac><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></label></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-e7bb3ccb data-v-12fd6330 data-v-0b887ec4><!--[--><a class="VPSocialLink" href="https://github.com/liuhq8796/blog" aria-label="github" target="_blank" rel="noopener" data-v-0b887ec4 data-v-6c5013a0><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-e7bb3ccb data-v-39fa8f10 data-v-80ddfb18><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-80ddfb18><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="icon" data-v-80ddfb18><circle cx="12" cy="12" r="2"></circle><circle cx="19" cy="12" r="2"></circle><circle cx="5" cy="12" r="2"></circle></svg></button><div class="menu" data-v-80ddfb18><div class="VPMenu" data-v-80ddfb18 data-v-5e0939d0><!----><!--[--><!--[--><!----><div class="group" data-v-39fa8f10><div class="item appearance" data-v-39fa8f10><p class="label" data-v-39fa8f10>深色模式</p><div class="appearance-action" data-v-39fa8f10><label title="toggle dark mode" data-v-39fa8f10 data-v-82e841ac><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" aria-checked="false" data-v-82e841ac data-v-62d1e791><span class="check" data-v-62d1e791><span class="icon" data-v-62d1e791><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-82e841ac><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-82e841ac><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></label></div></div></div><div class="group" data-v-39fa8f10><div class="item social-links" data-v-39fa8f10><div class="VPSocialLinks social-links-list" data-v-39fa8f10 data-v-0b887ec4><!--[--><a class="VPSocialLink" href="https://github.com/liuhq8796/blog" aria-label="github" target="_blank" rel="noopener" data-v-0b887ec4 data-v-6c5013a0><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-e7bb3ccb data-v-5dfbe683><span class="container" data-v-5dfbe683><span class="top" data-v-5dfbe683></span><span class="middle" data-v-5dfbe683></span><span class="bottom" data-v-5dfbe683></span></span></button></div></div></div></div><!----></header><div class="VPLocalNav" data-v-949fe70a data-v-33f63db2><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-33f63db2><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="menu-icon" data-v-33f63db2><path d="M17,11H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,11,17,11z"></path><path d="M21,7H3C2.4,7,2,6.6,2,6s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,7,21,7z"></path><path d="M21,15H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,15,21,15z"></path><path d="M17,19H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,19,17,19z"></path></svg><span class="menu-text" data-v-33f63db2>目录</span></button><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-33f63db2 data-v-7ad4cd76><button data-v-7ad4cd76>回到顶部</button><!----></div></div><aside class="VPSidebar" data-v-949fe70a data-v-10f8fa65><div class="curtain" data-v-10f8fa65></div><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-10f8fa65><span class="visually-hidden" id="sidebar-aria-label" data-v-10f8fa65> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="group" data-v-10f8fa65><div class="VPSidebarItem level-0" data-v-10f8fa65 data-v-17243f58><div class="item" role="button" tabindex="0" data-v-17243f58><div class="indicator" data-v-17243f58></div><p class="text" data-v-17243f58>JS</p><!----></div><!----></div></div><div class="group" data-v-10f8fa65><section class="VPSidebarItem level-0" data-v-10f8fa65 data-v-17243f58><div class="item" role="button" tabindex="0" data-v-17243f58><div class="indicator" data-v-17243f58></div><h2 class="text" data-v-17243f58>CSS</h2><!----></div><div class="items" data-v-17243f58><!--[--><div class="VPSidebarItem level-1 is-link" data-v-17243f58 data-v-17243f58><div class="item" data-v-17243f58><div class="indicator" data-v-17243f58></div><a class="VPLink link link" href="/articles/css/bem-and-atomic-css-methodology.html" data-v-17243f58 data-v-fd01078a><!--[--><p class="text" data-v-17243f58>BEM 与 Atomic CSS 方法论</p><!--]--><!----></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-10f8fa65><div class="VPSidebarItem level-0" data-v-10f8fa65 data-v-17243f58><div class="item" role="button" tabindex="0" data-v-17243f58><div class="indicator" data-v-17243f58></div><p class="text" data-v-17243f58>HTML</p><!----></div><!----></div></div><div class="group" data-v-10f8fa65><section class="VPSidebarItem level-0 has-active" data-v-10f8fa65 data-v-17243f58><div class="item" role="button" tabindex="0" data-v-17243f58><div class="indicator" data-v-17243f58></div><h2 class="text" data-v-17243f58>Nginx</h2><!----></div><div class="items" data-v-17243f58><!--[--><div class="VPSidebarItem level-1 is-link is-active has-active" data-v-17243f58 data-v-17243f58><div class="item" data-v-17243f58><div class="indicator" data-v-17243f58></div><a class="VPLink link link" href="/articles/nginx/running-javascript-in-nginx.html" data-v-17243f58 data-v-fd01078a><!--[--><p class="text" data-v-17243f58>在 Nginx 中运行 JavaScript</p><!--]--><!----></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-17243f58 data-v-17243f58><div class="item" data-v-17243f58><div class="indicator" data-v-17243f58></div><a class="VPLink link link" href="/articles/nginx/javascript-in-nginx-configuration.html" data-v-17243f58 data-v-fd01078a><!--[--><p class="text" data-v-17243f58>Nginx 配置中的 JavaScript</p><!--]--><!----></a><!----></div><!----></div><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-949fe70a data-v-c2ae6d7b><div class="VPDoc has-sidebar has-aside" data-v-c2ae6d7b data-v-363bef15><!--[--><!--]--><div class="container" data-v-363bef15><div class="aside" data-v-363bef15><div class="aside-curtain" data-v-363bef15></div><div class="aside-container" data-v-363bef15><div class="aside-content" data-v-363bef15><div class="VPDocAside" data-v-363bef15 data-v-9998149e><!--[--><!--]--><!--[--><!--]--><div class="VPDocAsideOutline" data-v-9998149e data-v-928df2ff><div class="content" data-v-928df2ff><div class="outline-marker" data-v-928df2ff></div><div class="outline-title" data-v-928df2ff>页面导航</div><nav aria-labelledby="doc-outline-aria-label" data-v-928df2ff><span class="visually-hidden" id="doc-outline-aria-label" data-v-928df2ff> Table of Contents for current page </span><ul class="root" data-v-928df2ff data-v-0e5227cd><!--[--><!--]--></ul></nav></div></div><!--[--><!--]--><div class="spacer" data-v-9998149e></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-363bef15><div class="content-container" data-v-363bef15><!--[--><!--]--><!----><main class="main" data-v-363bef15><div style="position:relative;" class="vp-doc _articles_nginx_running-javascript-in-nginx" data-v-363bef15><div><h1 id="在-nginx-中运行-javascript" tabindex="-1">在 Nginx 中运行 JavaScript <a class="header-anchor" href="#在-nginx-中运行-javascript" aria-label="Permalink to &quot;在 Nginx 中运行 JavaScript&quot;">​</a></h1><h2 id="目录" tabindex="-1">目录 <a class="header-anchor" href="#目录" aria-label="Permalink to &quot;目录&quot;">​</a></h2><ul><li>技术背景</li><li>初识</li><li>NJS 的用例</li></ul><h2 id="技术背景" tabindex="-1">技术背景 <a class="header-anchor" href="#技术背景" aria-label="Permalink to &quot;技术背景&quot;">​</a></h2><h3 id="扩展-nginx-功能的四种方式" tabindex="-1">扩展 NGINX 功能的四种方式 <a class="header-anchor" href="#扩展-nginx-功能的四种方式" aria-label="Permalink to &quot;扩展 NGINX 功能的四种方式&quot;">​</a></h3><p>C-Modules、Perl、Lua、JavaScript</p><p><img src="/assets/nginx-modules.034bac7a.png" alt="nginx-modules"></p><h3 id="njs-核心价值" tabindex="-1">NJS 核心价值 <a class="header-anchor" href="#njs-核心价值" aria-label="Permalink to &quot;NJS 核心价值&quot;">​</a></h3><p>使用脚本的方式扩展应用服务能力</p><ul><li>减少开发投入：减少用户独立使用 C 语言开发特定场景的 nginx 模块的可能性。</li><li>降低使用难度：将 JavaScript 代码集成到 nginx HTTP 和流（TCP/UDP）模块的事件处理模型中。</li><li>提高产出效率：使用 JavaScript 代码扩展 nginx 配置语法，以实现复杂的配置解决方案。</li></ul><h3 id="njs-与-node-js、javascript-的区别" tabindex="-1">NJS 与 Node.js、JavaScript 的区别 <a class="header-anchor" href="#njs-与-node-js、javascript-的区别" aria-label="Permalink to &quot;NJS 与 Node.js、JavaScript 的区别&quot;">​</a></h3><p>一、运行时不同</p><p>Node.js 使用 Google V8 JavaScript 引擎，而 NGINX JavaScript 则是基于 ECMAScript 标准的定制化实现，专为 NGINX 设计。Node.js 在内存中有一个持久化的 JavaScript 虚拟机 (VM)，执行日常垃圾回收以管理内存；而 NGINX JavaScript 针对每个请求都会初始化一个新的 JavaScript VM 以及其所需的内存，并在请求完成时释放内存空间。</p><p>二、语言规范差异</p><p>JavaScript 的规范由 ECMAScript 标准定义。NGINX JavaScript 遵循 ECMAScript 5.1 和一些 ECMAScript 6 标准（面向数学函数）。通过实现自己的 JavaScript 运行时，njs 能够优先确保对服务器端用例的语言支持，忽略不需要的项目。</p><h2 id="初识" tabindex="-1">初识 <a class="header-anchor" href="#初识" aria-label="Permalink to &quot;初识&quot;">​</a></h2><h3 id="安装-njs-模块" tabindex="-1">安装 NJS 模块 <a class="header-anchor" href="#安装-njs-模块" aria-label="Permalink to &quot;安装 NJS 模块&quot;">​</a></h3><p>以安装 njs 预编译模块为例，需要 nginx 版本是 1.9.11 或更高版本</p><ol><li>安装预构建包。 <ul><li>Ubuntu 和 Debian 系统：<div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">sudo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">apt-get</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">install</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx-module-njs</span></span></code></pre></div></li><li>RedHat、CentOS 和 Oracle Linux 系统：<div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">sudo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">yum</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">install</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx-module-njs</span></span></code></pre></div></li></ul></li><li>在 nginx.conf 配置文件的顶层（“main”）上下文（而非 http 或 stream 上下文）中添加一个 load_module 指令，以启用该模块。本例面向 HTTP 和 TCP/UDP 流量加载 JavaScript 模块。<div class="language-nginx"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">load_module </span><span style="color:#A6ACCD;">modules/ngx_http_js_module.so</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">load_module </span><span style="color:#A6ACCD;">modules/ngx_stream_js_module.so</span><span style="color:#89DDFF;">;</span></span></code></pre></div></li><li>重新加载 NGINX，以便将 NGINX JavaScript 模块加载到运行实例中。<div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">sudo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-s</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">reload</span></span></code></pre></div></li></ol><h3 id="njs-基本使用入门" tabindex="-1">NJS 基本使用入门 <a class="header-anchor" href="#njs-基本使用入门" aria-label="Permalink to &quot;NJS 基本使用入门&quot;">​</a></h3><p><img src="/assets/njs-demo.4f45feac.png" alt="njs-demo"></p><ol><li>启用 njs 模块</li><li>使用 js_import 引用 http.js 文件</li><li>使用 js_content 引用 http 文件中的 hello 方法</li><li>定义并导出 hello 方法</li></ol><h3 id="njs-异步方法" tabindex="-1">NJS 异步方法 <a class="header-anchor" href="#njs-异步方法" aria-label="Permalink to &quot;NJS 异步方法&quot;">​</a></h3><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">// 初始化连接</span></span>
<span class="line"><span style="color:#A6ACCD;">ngx</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">fetch</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">http://nginx.org/en/docs/njs</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// 当url返回时</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">then</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">reply</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#A6ACCD;"> reply</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">text</span><span style="color:#A6ACCD;">())</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// 当正文读取完成时</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">then</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">body</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#A6ACCD;"> r</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">return</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">200</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> body</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">toString</span><span style="color:#A6ACCD;">()))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// 如果出现了问题，就执行这里</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">catch</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">e</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#A6ACCD;"> r</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">return</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">501</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> e</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">message))</span></span></code></pre></div><h2 id="njs-的用例" tabindex="-1">NJS 的用例 <a class="header-anchor" href="#njs-的用例" aria-label="Permalink to &quot;NJS 的用例&quot;">​</a></h2><h3 id="njs-能做什么" tabindex="-1">NJS 能做什么 <a class="header-anchor" href="#njs-能做什么" aria-label="Permalink to &quot;NJS 能做什么&quot;">​</a></h3><ul><li>授权 <ul><li>生成 JWT 令牌</li><li>根据请求正文内容授权请求</li></ul></li><li>代理 <ul><li>将多个子请求的结果异步合并到单个回复中</li><li>链式访问多个子请求</li></ul></li><li>修改响应 <ul><li>修改或删除上游服务器发送的 Cookie</li><li>将响应正文字符转换为小写</li></ul></li><li>记录 <ul><li>使用 json 格式记录日志</li><li>记录每个客户端的请求数</li></ul></li><li>......</li></ul><h3 id="真实案例-使用-json-格式记录日志" tabindex="-1">真实案例 - 使用 json 格式记录日志 <a class="header-anchor" href="#真实案例-使用-json-格式记录日志" aria-label="Permalink to &quot;真实案例 - 使用 json 格式记录日志&quot;">​</a></h3><p>默认情况下 Nginx 打印出的日志是包含各种字段值的字符串，就像下面这样：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">172.23.0.1 - - [27/Oct/2022:12:24:45 +0000] &quot;GET / HTTP/1.1&quot; 200 10 &quot;-&quot; &quot;curl/7.79.1&quot; &quot;-&quot;</span></span></code></pre></div><p>这样的格式存在一些缺点：</p><ul><li>它本身是一种自定义格式 - 如果你想要读取它，需要编写特定的日志解析器</li><li>条目可能很长，让人难以阅读</li><li>无法记录存在不确定性的值，例如“所有请求头”</li></ul><p>我们可以通过使用 NGINX JavaScript 模块（njs）以结构化格式（如 JSON）编写日志条目来解决这些问题。</p><p>此示例的 NGINX 配置非常简单。</p><div class="language-nginx"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;"># nginx.conf</span></span>
<span class="line"><span style="color:#C792EA;">http</span><span style="color:#A6ACCD;"> {</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;"> js_import </span><span style="color:#A6ACCD;">  scripts/logging.js</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">                 </span><span style="color:#676E95;font-style:italic;"># 从这里加载 js 代码</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;"> js_set </span><span style="color:#A6ACCD;">     </span><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">access_log logging.loggingJson</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># 用 js 方法为变量赋值</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;"> log_format </span><span style="color:#A6ACCD;"> json </span><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">access_log</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">                   </span><span style="color:#676E95;font-style:italic;"># 定义特殊的日志格式</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">server</span><span style="color:#A6ACCD;"> {</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#89DDFF;"> listen </span><span style="color:#A6ACCD;">80</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#89DDFF;"> access_log </span><span style="color:#A6ACCD;">/var/log/nginx/access_json.log json</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">200</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">&#39;hello NJS</span><span style="color:#A6ACCD;">\n</span><span style="color:#C3E88D;">&#39;</span><span style="color:#A6ACCD;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    }</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span></code></pre></div><p>可以见到，NGINX JavaScript 代码并不内嵌在配置语法内。相反，我们使用 <a href="https://nginx.org/en/docs/http/ngx_http_js_module.html#js_import" target="_blank" rel="noreferrer">js_import</a> 指令来导入包含了所有 JavaScript 代码的文件。<a href="https://nginx.org/en/docs/http/ngx_http_js_module.html#js_set" target="_blank" rel="noreferrer">js_set</a> 指令定义了一个新的 NGINX 变量 <code>$access_log</code>，后面是为变量赋值的 JavaScript 函数。<a href="https://nginx.org/en/docs/http/ngx_http_log_module.html#log_format" target="_blank" rel="noreferrer">log_format</a> 指令定义了一种名为 json 的新格式，它能够将 <code>$access_log</code> 的值写入每个日志行。</p><p><a href="https://nginx.org/en/docs/http/ngx_http_core_module.html#server" target="_blank" rel="noreferrer">server</a> 块定义了一个简单的 HTTP 服务器，监听 80 端口。 <a href="https://nginx.org/en/docs/http/ngx_http_log_module.html#access_log" target="_blank" rel="noreferrer">access_log</a> 指令指定了日志文件路径以及所有请求均采用 json 格式进行记录。</p><p>现在，来看看日志处理的 JavaScript 代码。</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">loggingJson</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">r</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">var</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">log</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{}</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">var</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">indexes</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> [</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">remote_addr</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">remote_user</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">time_local</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">request</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">status</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">body_bytes_sent</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">http_referer</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">http_user_agent</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">  ]</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#F07178;"> (</span><span style="color:#C792EA;">var</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">n</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">in</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">indexes</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#C792EA;">var</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">key</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">indexes</span><span style="color:#F07178;">[</span><span style="color:#A6ACCD;">n</span><span style="color:#F07178;">]</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">log</span><span style="color:#F07178;">[</span><span style="color:#A6ACCD;">key</span><span style="color:#F07178;">] </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">r</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">variables</span><span style="color:#F07178;">[</span><span style="color:#A6ACCD;">key</span><span style="color:#F07178;">]</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">var</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">headerTypes</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> [</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">headersIn</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">headersOut</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">]</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#F07178;"> (</span><span style="color:#C792EA;">var</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">m</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">in</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">headerTypes</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#C792EA;">var</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">type</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">headerTypes</span><span style="color:#F07178;">[</span><span style="color:#A6ACCD;">m</span><span style="color:#F07178;">]</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">log</span><span style="color:#F07178;">[</span><span style="color:#A6ACCD;">type</span><span style="color:#F07178;">] </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{}</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#C792EA;">var</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">headers</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">r</span><span style="color:#F07178;">[</span><span style="color:#A6ACCD;">type</span><span style="color:#F07178;">]</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#F07178;"> (</span><span style="color:#C792EA;">var</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">n</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">in</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">headers</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#A6ACCD;">log</span><span style="color:#F07178;">[</span><span style="color:#A6ACCD;">type</span><span style="color:#F07178;">][</span><span style="color:#A6ACCD;">n</span><span style="color:#F07178;">] </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">headers</span><span style="color:#F07178;">[</span><span style="color:#A6ACCD;">n</span><span style="color:#F07178;">]</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">var</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">logStr</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">JSON</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">stringify</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">log</span><span style="color:#F07178;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">while</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">logStr</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">indexOf</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">&quot;</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">!=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">-</span><span style="color:#F78C6C;">1</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">logStr</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">logStr</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">replace</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">&quot;</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">&#39;</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">logStr</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">default</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> loggingJson </span><span style="color:#89DDFF;">}</span></span></code></pre></div><p>NGINX 变量只有在被需要的时候才会进行求值计算，这意味着 js_set 定义的 JavaScript 函数只在需要该变量的值时才执行。在此示例中，由于 $access_log 被用于 <a href="https://nginx.org/en/docs/http/ngx_http_log_module.html#log_format" target="_blank" rel="noreferrer">log_format</a> 指令，因此 json() 在日志记录时执行。</p><p>以下是本示例的真实日志:</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">$</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">tail</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-1</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/var/log/nginx/access_json.log</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">{</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">remote_addr</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">:</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">172.27.0.1</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">time_local</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">:</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">28/Oct/2022:03:31:20 +0000</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">request</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">:</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">GET / HTTP/1.1</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">status</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">:</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">200</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">body_bytes_sent</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">:</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">10</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">http_user_agent</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">:</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">curl/7.79.1</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">headersIn</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">:</span><span style="color:#89DDFF;">{</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">Host</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">:</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">localhost:8095</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">User-Agent</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">:</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">curl/7.79.1</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">Accept</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">:</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">*/*</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;">,</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">headersOut</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">:</span><span style="color:#89DDFF;">{</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">Content-Type</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">:</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">text/plain</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">Content-Length</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">:</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">10</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">}}</span></span></code></pre></div><p>其实如果是正常的日志没必要做这么详细的记录，我们还可以实现仅在遇到错误时再生成这样的数据，记录到单独的日志文件中，方便我们进行故障排除。不过那就需要更多额外的 nginx 配置，这里就不展开了。</p><h2 id="结语" tabindex="-1">结语 <a class="header-anchor" href="#结语" aria-label="Permalink to &quot;结语&quot;">​</a></h2><p>在 njs 之前，Nginx+Lua 生态虽然已经十分成熟，但 Nginx 毕竟是一个 Web 服务器，JavaScript 作为 Web 开发的最流行的语言，用 JavaScript 生态来扩展 Nginx 的功能，可能会做出更多具有想象力的事情。</p><h2 id="相关链接" tabindex="-1">相关链接 <a class="header-anchor" href="#相关链接" aria-label="Permalink to &quot;相关链接&quot;">​</a></h2><p>NJS 文档：</p><p><a href="http://nginx.org/en/docs/njs/" target="_blank" rel="noreferrer">http://nginx.org/en/docs/njs/</a></p><p>应用示例：</p><p><a href="https://github.com/nginx/njs-examples" target="_blank" rel="noreferrer">https://github.com/nginx/njs-examples</a></p><p><a href="https://github.com/f5devcentral/nginx-njs-usecases" target="_blank" rel="noreferrer">https://github.com/f5devcentral/nginx-njs-usecases</a></p><p>博客：</p><p><a href="https://nginx.com/blog/tag/javascript" target="_blank" rel="noreferrer">https://nginx.com/blog/tag/javascript</a></p><p>源代码：</p><p><a href="https://github.com/nginx/njs" target="_blank" rel="noreferrer">https://github.com/nginx/njs</a></p></div></div></main><footer class="VPDocFooter" data-v-363bef15 data-v-a12c118f><!--[--><!--]--><div class="edit-info" data-v-a12c118f><!----><div class="last-updated" data-v-a12c118f><p class="VPLastUpdated" data-v-a12c118f data-v-5bb73c18>Last updated: <time datetime="2023-04-19T09:12:46.000Z" data-v-5bb73c18></time></p></div></div><div class="prev-next" data-v-a12c118f><div class="pager" data-v-a12c118f><a class="pager-link prev" href="/articles/css/bem-and-atomic-css-methodology.html" data-v-a12c118f><span class="desc" data-v-a12c118f>Previous page</span><span class="title" data-v-a12c118f>BEM 与 Atomic CSS 方法论</span></a></div><div class="has-prev pager" data-v-a12c118f><a class="pager-link next" href="/articles/nginx/javascript-in-nginx-configuration.html" data-v-a12c118f><span class="desc" data-v-a12c118f>Next page</span><span class="title" data-v-a12c118f>Nginx 配置中的 JavaScript</span></a></div></div></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><!----><!--[--><!--]--></div></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"articles_css_index.md\":\"ea66086d\",\"articles_css_bem-and-atomic-css-methodology.md\":\"c84182de\",\"articles_index.md\":\"16e88a90\",\"articles_nginx_index.md\":\"99f2f53c\",\"articles_nginx_javascript-in-nginx-configuration.md\":\"7b4ac113\",\"index.md\":\"8ab108cb\",\"articles_nginx_running-javascript-in-nginx.md\":\"2c2b9be3\"}")
__VP_SITE_DATA__ = JSON.parse("{\"lang\":\"en-US\",\"dir\":\"ltr\",\"title\":\"学海拾贝\",\"titleTemplate\":\"LucasLiu's 博客网站\",\"description\":\"LucasLiu's 博客网站\",\"base\":\"/\",\"head\":[],\"appearance\":true,\"themeConfig\":{\"nav\":[{\"text\":\"首页\",\"link\":\"/\"},{\"text\":\"全部文章\",\"link\":\"/articles/\"}],\"outlineTitle\":\"页面导航\",\"sidebar\":[{\"text\":\"JS\",\"items\":[]},{\"text\":\"CSS\",\"items\":[{\"text\":\"BEM 与 Atomic CSS 方法论\",\"link\":\"/articles/css/bem-and-atomic-css-methodology\"}]},{\"text\":\"HTML\",\"items\":[]},{\"text\":\"Nginx\",\"items\":[{\"text\":\"在 Nginx 中运行 JavaScript\",\"link\":\"/articles/nginx/running-javascript-in-nginx\"},{\"text\":\"Nginx 配置中的 JavaScript\",\"link\":\"/articles/nginx/javascript-in-nginx-configuration\"}]}],\"socialLinks\":[{\"icon\":\"github\",\"link\":\"https://github.com/liuhq8796/blog\"}],\"darkModeSwitchLabel\":\"深色模式\",\"sidebarMenuLabel\":\"目录\",\"returnToTopLabel\":\"回到顶部\"},\"locales\":{},\"scrollOffset\":90,\"cleanUrls\":false}")</script>
    
  </body>
</html>